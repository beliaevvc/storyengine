# Рефлексия: STORY-002 — Entity as Document System

**Дата:** 2026-01-17  
**Уровень сложности:** 3 (Intermediate Feature)  
**Статус:** ✅ Завершено

---

## Краткое описание

Задача заключалась в переработке системы entities (персонажи, локации, предметы и т.д.) так, чтобы каждый entity открывался как полноценный документ в центральном редакторе с системой вкладок.

---

## Что получилось хорошо

### 1. Архитектура
- Чёткое разделение ответственности между stores (WorkspaceStore, EntityStore, DocumentStore)
- Переиспользование существующего Tiptap редактора для entities
- Единый паттерн для document tabs и entity tabs

### 2. UX
- Клик на entity → сразу открывается в редакторе (не нужен double-click)
- Шаблоны со структурированными секциями для каждого типа entity
- Auto-save работает корректно
- Context menu на вкладках (закрыть, закрыть другие, закрыть все)

### 3. Код
- Типизация: TiptapContent, Tab, TabType — всё строго типизировано
- Selectors для оптимизации рендеринга
- Persist middleware для сохранения открытых вкладок между сессиями

---

## Трудности

### 1. Конфликт имён
- `selectActiveTab` экспортировался из двух stores (UIStore и WorkspaceStore)
- **Решение:** Переименовал в WorkspaceStore на `selectActiveWorkspaceTab`

### 2. Интеграция с существующим кодом
- WorkspacePanel имел свои "mode tabs" (Редактор, Сюжет, Таймлайн)
- Пользователь уже перенёс mode tabs в header, что упростило интеграцию DocumentTabs

### 3. Миграция базы данных
- Нужно было синхронизировать изменения между Supabase, Prisma и TypeScript типами
- Три места требовали обновления: SQL миграция, Prisma schema, types/supabase.ts

---

## Уроки

### 1. Именование
- При добавлении новых stores проверять уникальность имён экспортируемых функций
- Использовать namespace-подобные префиксы: `selectWorkspace*`, `selectUI*`

### 2. Инкрементальная интеграция
- Лучше интегрировать по частям и проверять компиляцию после каждого шага
- Конфликт имён обнаружился только при сборке

### 3. Шаблоны
- Структурированные шаблоны для entities — отличная идея
- В будущем можно добавить кастомизируемые шаблоны

---

## Технические улучшения

### Реализовано
- Entity content хранится в JSONB (Tiptap JSON)
- WorkspaceStore с persist для сохранения открытых tabs
- EntityEditor с header показывающим тип и название entity

### Для будущего
- [ ] Кастомизируемые шаблоны для entities
- [ ] Drag & drop для переупорядочивания вкладок
- [ ] Split view для одновременного просмотра нескольких документов
- [ ] Keyboard shortcuts для переключения между вкладками (Cmd+1, Cmd+2, etc.)

---

## Метрики

| Метрика | Значение |
|---------|----------|
| Новых файлов | 6 |
| Изменённых файлов | 10 |
| Строк кода (примерно) | ~600 |
| Время выполнения | ~1 сессия |

---

## Связанные документы

- **План:** `/Users/sergejbelaev/.cursor/plans/entity_as_document_system_44ce7ac6.plan.md`
- **Tasks:** `memory-bank/tasks.md`
- **Archive:** `memory-bank/archive/archive-STORY-002.md` (создать при архивации)
