# Рефлексия: SCENE-002

## Информация о задаче
- **ID:** SCENE-002
- **Название:** Исчезновение сцен после обновления страницы
- **Уровень:** 2 (Bug fix)
- **Дата:** 2026-01-18
- **Статус:** ✅ ЗАВЕРШЕНО

---

## Краткое описание

**Проблема:** Пользователь создавал сцены в документе, но после обновления страницы (F5) они исчезали.

**Причина:** `editor.getJSON()` в Tiptap возвращает объекты с null prototype, которые Next.js Server Actions отклоняют с ошибкой:
```
Error: Only plain objects, and a few built-ins, can be passed to Server Actions. Classes or null prototypes are not supported.
```

**Решение:** Добавлена сериализация через `JSON.parse(JSON.stringify(content))` перед передачей в Server Action.

---

## Что прошло хорошо

### 1. Систематический подход к диагностике
- Добавлено логирование на всех этапах flow: создание → сохранение → загрузка
- Это позволило быстро локализовать проблему в консоли браузера

### 2. Понимание архитектуры
- Быстро разобрался в потоке данных: Tiptap → WorkspacePanel → Server Action → Supabase
- Документирование архитектуры в tasks.md помогло структурировать анализ

### 3. Минимальное исправление
- Исправление заняло одну строку кода
- Не потребовалось менять архитектуру или рефакторить

---

## Сложности

### 1. Неочевидная ошибка
- Ошибка сериализации не сразу видна без открытой консоли
- Статус "Сохранение..." просто зависал без явного сообщения об ошибке в UI

### 2. Особенность Next.js Server Actions
- Server Actions имеют строгие требования к сериализуемости данных
- Это не документировано явно в контексте использования с Tiptap

---

## Уроки

### 1. Всегда сериализовать данные для Server Actions
```typescript
// НЕПРАВИЛЬНО - может содержать null prototypes
await serverAction(editor.getJSON());

// ПРАВИЛЬНО - гарантированно plain object
await serverAction(JSON.parse(JSON.stringify(editor.getJSON())));
```

### 2. Логирование критично для отладки
- Console.log на каждом этапе flow спасает часы отладки
- Особенно важно логировать ошибки в catch блоках

### 3. Проверять ошибки в консоли браузера
- Ошибка была видна сразу в консоли, но без логирования её было бы сложнее найти

---

## Улучшения процесса

### Для будущих задач
1. При работе с Server Actions всегда проверять сериализуемость данных
2. Добавлять toast/notification при ошибках сохранения, не только в консоль
3. Рассмотреть добавление error boundary для отлова таких ошибок

### Технический долг
- [ ] Убрать debug логи после стабилизации (или оставить под флагом DEBUG)
- [ ] Добавить UI индикацию ошибок сохранения (toast notification)

---

## Изменённые файлы

| Файл | Изменение |
|------|-----------|
| `src/presentation/components/workspace/WorkspacePanel.tsx` | Добавлена сериализация `JSON.parse(JSON.stringify(content))` |
| `src/presentation/components/editor/Editor.tsx` | Добавлено debug логирование |
| `src/presentation/hooks/useDocumentsLoader.ts` | Добавлено debug логирование |
| `src/app/actions/supabase/document-actions.ts` | Добавлено debug логирование + проверка результата update |

---

## Время выполнения

- Анализ архитектуры: ~10 мин
- Добавление диагностики: ~5 мин
- Локализация проблемы: ~2 мин (после получения скриншота консоли)
- Исправление: ~1 мин

**Итого:** ~20 минут

---

## Связанные задачи

- **SCENE-001:** Доработка блока сцены (предшествующая задача)
- Потенциально аналогичная проблема может быть в `EntityEditor` если он использует похожий pattern
