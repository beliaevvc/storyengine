# Рефлексия: DND-001 — Исправление Drag & Drop файлов

**Дата:** 2026-01-18  
**Уровень:** 2 (Bug fix + Enhancement)  
**Статус:** ✅ Завершено

---

## Краткое описание

Исправлена проблема, при которой файлы (документы) в левой панели не перемещались через drag & drop, хотя папки работали корректно. В процессе также добавлена возможность изменения порядка документов внутри одной папки и улучшены стили поля ввода при переименовании.

---

## Что было сделано

### 1. Исправление перемещения документов между папками
**Проблема:** Условие `!newParentId || newParentId === currentParentId` блокировало перемещение, когда целевой элемент находился в корне (`parentId = null`).

**Решение:** Убрано `!newParentId`, оставлено только `newParentId === currentParentId`.

### 2. Добавление reorder документов внутри папки
**Проблема:** При перетаскивании документа на другой документ в той же папке ничего не происходило.

**Первая попытка (неудачная):** Использование дробных значений order (0.5, 1.5). Не сработало, т.к. поле `order` в БД имеет тип `Int` и округляет значения.

**Решение:** Полный пересчёт order для всех siblings после перемещения:
1. Находим индексы dragged и target
2. Удаляем dragged из массива
3. Вставляем после target
4. Обновляем order для всех документов (0, 1, 2, ...)

### 3. Улучшение стилей input переименования
**Проблема:** Белый фон и яркий border не соответствовали тёмной теме sidebar.

**Решение:** Использованы токены дизайн-системы:
- `bg-overlay` (#2d333b)
- `border-border-muted` (#30363d)
- `text-fg`
- Focus ring с accent цветом

---

## Что пошло хорошо

1. **Быстрая локализация бага** — семантический поиск сразу нашёл `FileTree.tsx`
2. **Логирование** — добавление console.log помогло понять flow выполнения
3. **Итеративный подход** — каждое исправление тестировалось отдельно

---

## Проблемы и решения

| Проблема | Причина | Решение |
|----------|---------|---------|
| Документы не перемещались в корень | `!newParentId` блокировало null | Убрали проверку |
| Reorder с дробными числами не работал | `order` — Int в БД | Пересчёт всех siblings |
| Input выглядел чужеродно | Неправильные CSS классы | Использовали токены темы |

---

## Уроки

1. **Проверять типы в БД** — дробные значения для Int округляются
2. **Использовать существующие токены** — не изобретать цвета, смотреть в `tailwind.config.ts`
3. **Логирование на всех этапах** — помогает понять где именно код не работает

---

## Изменённые файлы

| Файл | Изменения |
|------|-----------|
| `src/presentation/components/explorer/FileTree.tsx` | Логика drag & drop, reorder документов |
| `src/presentation/components/explorer/FileTreeItem.tsx` | Стили input переименования |

---

## Рекомендации на будущее

1. **Нормализация order** — периодически пересчитывать order для всех документов, чтобы избежать дыр в нумерации
2. **Batch updates** — при reorder обновлять все siblings одним запросом, а не в цикле
3. **Optimistic UI** — показывать результат сразу, откатывать при ошибке
