# Рефлексия: EDITOR-001 — Улучшения блочной архитектуры редактора

**Дата:** 2026-01-18  
**Уровень:** 3 (Intermediate Feature)  
**Статус:** ✅ Завершено

---

## Резюме

Комплексное улучшение архитектуры редактора StoryEngine:
- Строгое применение схемы (весь контент внутри semantic blocks)
- Исправление миграции для новых документов
- Редизайн UI блоков и BubbleMenu
- Улучшение поведения меню при скролле

---

## Что было сделано

### 1. Строгая схема контента
- **SceneExtension.ts**: `content: 'semanticBlock+'` вместо `'block+'`
- Все команды создания контента теперь вставляют `semanticBlock` с `blockType: 'empty'`
- Невозможно писать вне блоков в syntax режиме

### 2. Миграция документов
- **migrateDocument.ts**: Обновлены функции:
  - `createSceneNode()` — оборачивает контент в semantic block
  - `createEmptyDocument()` — создаёт сцену с пустым блоком
  - `createDefaultDocumentContent()` — правильная начальная структура

### 3. UI блоков (SemanticBlockView)
- Добавлена разделительная линия между заголовком и контентом
- Границы блоков теперь всегда видны (`border-[#3a3f4b]`)
- Тип `'empty'` с селектором для конвертации

### 4. BubbleMenu
- Иконки вместо текстовых меток (`[DLG]` → иконка MessageCircle)
- Более контрастный дизайн (темнее, чётче граница)
- Улучшенное поведение при скролле (прямое обновление DOM)

---

## Что пошло хорошо

1. **Чёткое понимание архитектуры** — быстро нашёл все места где создаётся контент
2. **Инкрементальный подход** — сначала схема, потом миграция, потом UI
3. **Консистентность дизайна** — блоки визуально соответствуют сценам
4. **Быстрая итерация** — пользователь сразу видит результат и даёт фидбек

---

## Сложности

### 1. Позиционирование BubbleMenu при скролле
- **Проблема**: `fixed` позиционирование создавало лаг при скролле
- **Попытка 1**: `requestAnimationFrame` — всё ещё лаг
- **Попытка 2**: `absolute` + `scrollY` — неправильный offset
- **Решение**: `fixed` + прямое обновление DOM через `menuRef.current.style`

### 2. Layout shift при hover
- **Проблема**: Появление border при hover смещало контент
- **Решение**: Использовать `box-shadow` или всегда показывать border

### 3. Консистентность схемы во всех документах
- **Проблема**: Новые документы создавались со старой структурой
- **Решение**: Обновить все функции в `migrateDocument.ts`

---

## Уроки

1. **DOM vs React State для анимаций** — для zero-lag скролла лучше напрямую обновлять DOM
2. **Box-shadow vs Border** — для hover эффектов без layout shift использовать box-shadow
3. **Единая точка создания контента** — все функции создания должны использовать одну схему
4. **Tiptap schema строгая** — если указать `content: 'semanticBlock+'`, редактор сам будет следить за структурой

---

## Улучшения процесса

1. **Сначала схема, потом UI** — техническая консистентность важнее визуальной
2. **Тестировать новые документы** — не только существующие
3. **Проверять все entry points** — где может создаться контент

---

## Технические улучшения

1. **Централизовать создание контента** — возможно создать `createEmptyBlock()` utility
2. **Типизация blockType** — уже есть `SemanticBlockType`, использовать везде
3. **CSS переменные для цветов** — сейчас hardcoded hex, лучше через design tokens

---

## Следующие шаги

1. [ ] Проверить поведение BubbleMenu — пользователь сообщал о проблемах
2. [ ] Возможно добавить 5-й тип блока "Нарратив" для голоса рассказчика
3. [ ] Добавить атрибуты сцены (флэшбек, сон, время)
4. [ ] Тестирование миграции старых документов

---

## Изменённые файлы

```
src/presentation/components/editor/extensions/
├── SceneExtension.ts          # content: 'semanticBlock+'
├── SemanticBlockView.tsx      # UI с линией и границами
├── SemanticBlock.ts           # type: 'empty' по умолчанию
├── SlashCommands.ts           # /block команда

src/presentation/components/editor/
├── BubbleMenu.tsx             # Иконки, скролл

src/presentation/utils/
├── migrateDocument.ts         # Создание с semantic blocks
```

---

## Верификация

- [x] Реализация проверена
- [x] What Went Well задокументировано
- [x] Сложности задокументированы
- [x] Уроки задокументированы
- [x] Улучшения процесса определены
- [x] Технические улучшения определены
- [x] Следующие шаги записаны

→ Готово к архивации
