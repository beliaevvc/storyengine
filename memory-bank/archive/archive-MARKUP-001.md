# –ê–†–•–ò–í –ó–ê–î–ê–ß–ò: MARKUP-001 ‚Äî –°–∏—Å—Ç–µ–º–∞ —Ä—É—á–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏ –±–ª–æ–∫–æ–≤

## –ú–ï–¢–ê–î–ê–ù–ù–´–ï

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|
| **Task ID** | MARKUP-001 |
| **–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞** | 2026-01-18 |
| **–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è** | 2026-01-18 |
| **–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏** | 3 (Intermediate Feature) |
| **–°—Ç–∞—Ç—É—Å** | ‚úÖ ARCHIVED |

---

## –ö–†–ê–¢–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ä—É—á–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ StoryEngine, –ø–æ–∑–≤–æ–ª—è—é—â–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
- –ü–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ "–ß–∏—Å—Ç–æ–º" —Ä–µ–∂–∏–º–µ –±–µ–∑ –æ—Ç–≤–ª–µ—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ç–∫—É
- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –≤ "–°–∏–Ω—Ç–∞–∫—Å–∏—Å" –¥–ª—è —Ä–∞–∑–º–µ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –í—ã–¥–µ–ª—è—Ç—å —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∑–Ω–∞—á–∞—Ç—å –µ–º—É —Ç–∏–ø (–¥–∏–∞–ª–æ–≥, –æ–ø–∏—Å–∞–Ω–∏–µ, –¥–µ–π—Å—Ç–≤–∏–µ, –º—ã—Å–ª–∏)
- –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—Ü–µ–Ω—ã –∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –±–ª–æ–∫–∏ —Ü–µ–ª–∏–∫–æ–º –≤ –Ω–æ–≤—ã–µ —Å—Ü–µ–Ω—ã

---

## –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### –ò—Å—Ö–æ–¥–Ω–∞—è –∑–∞–¥–∞—á–∞
- –£–±—Ä–∞—Ç—å AI-—Ä–∞–∑–º–µ—Ç–∫—É (–Ω–µ–Ω–∞–¥—ë–∂–Ω–∞—è, –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª–∞ —Ç–µ–∫—Å—Ç)
- –î–æ–±–∞–≤–∏—Ç—å —Ä—É—á–Ω—É—é —Ä–∞–∑–º–µ—Ç–∫—É —á–µ—Ä–µ–∑ UI
- –ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ "–ß–∏—Å—Ç–æ–º" —Ä–µ–∂–∏–º–µ –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ –Ω–µ—Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–π –±–ª–æ–∫
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ü–µ–Ω—ã –∏–∑ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- ‚úÖ –¢–∏–ø –±–ª–æ–∫–∞ `unmarked` —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –†–∞–∑–º–µ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ BubbleMenu
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω –∏–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –±–ª–æ–∫–∞ –≤ –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤

---

## –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

### 1. –ù–æ–≤—ã–π —Ç–∏–ø –±–ª–æ–∫–∞ `unmarked`

**–§–∞–π–ª:** `src/presentation/components/editor/extensions/SemanticBlock.ts`

```typescript
export type SemanticBlockType = 
  | 'empty' 
  | 'unmarked'  // NEW
  | 'dialogue' 
  | 'description' 
  | 'action' 
  | 'thought';
```

### 2. UI –¥–ª—è unmarked –±–ª–æ–∫–æ–≤

**–§–∞–π–ª:** `src/presentation/components/editor/extensions/SemanticBlockView.tsx`

- –ú–µ—Ç–∫–∞ "–ù–µ—Ä–∞–∑–º–µ—á–µ–Ω–Ω—ã–π"
- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ —Ç–∏–ø–æ–≤ (üí¨ üì∑ ‚ö° üß†)
- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ —Å—Ü–µ–Ω—É (üé¨)

### 3. –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤

**–§–∞–π–ª:** `src/presentation/components/editor/Toolbar.tsx`

```typescript
// –ß–∏—Å—Ç—ã–π ‚Üí –°–∏–Ω—Ç–∞–∫—Å–∏—Å: empty —Å —Ç–µ–∫—Å—Ç–æ–º ‚Üí unmarked
if (mode === 'syntax') {
  // Convert empty blocks with text to unmarked
  positions.forEach((pos) => {
    tr.setNodeMarkup(pos, undefined, { blockType: 'unmarked' });
  });
}

// –°–∏–Ω—Ç–∞–∫—Å–∏—Å ‚Üí –ß–∏—Å—Ç—ã–π: –¥–æ–±–∞–≤–∏—Ç—å unmarked –≤ –∫–æ–Ω–µ—Ü (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
if (mode === 'clean' && lastBlockType !== 'unmarked') {
  editor.chain().insertContentAt(lastSceneEnd, {
    type: 'semanticBlock',
    attrs: { blockType: 'unmarked' },
    content: [{ type: 'paragraph' }],
  }).run();
}
```

### 4. –†–∞–∑–º–µ—Ç–∫–∞ —á–µ—Ä–µ–∑ BubbleMenu

**–§–∞–π–ª:** `src/presentation/components/editor/BubbleMenu.tsx`

```typescript
// –ò–∑–≤–ª–µ—á—å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –Ω–æ–≤—ã–π –±–ª–æ–∫
const markBlock = (blockType) => {
  // Delete selection
  tr.delete(from, to);
  // Insert new block before unmarked
  tr.insert(blockPos, newBlock);
};

// –°–æ–∑–¥–∞—Ç—å —Å—Ü–µ–Ω—É –∏–∑ –≤—ã–¥–µ–ª–µ–Ω–∏—è
const createSceneFromSelection = () => {
  const slice = editor.state.doc.slice(from, to);
  // Create scene with unmarked block containing selection
  tr.insert(adjustedPos, newScene);
};
```

### 5. –ü–µ—Ä–µ–Ω–æ—Å –±–ª–æ–∫–∞ –≤ –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É

**–§–∞–π–ª:** `src/presentation/components/editor/extensions/SemanticBlockView.tsx`

```typescript
const handleMoveToNewScene = () => {
  // Copy block content (preserves paragraphs)
  const blockContent = node.content;
  
  // Create new scene with this content
  const newScene = schema.nodes.scene.create(
    { title: '–ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞' },
    schema.nodes.semanticBlock.create(
      { blockType: 'unmarked' },
      blockContent  // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É!
    )
  );
  
  // Delete original, insert scene
  tr.delete(pos, pos + nodeSize);
  tr.insert(adjustedPos, newScene);
};
```

---

## –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´

| –§–∞–π–ª | –¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|---------------|----------|
| `SemanticBlock.ts` | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è | –î–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø `unmarked` |
| `SemanticBlockView.tsx` | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è | UI –¥–ª—è unmarked, –∫–Ω–æ–ø–∫–∞ üé¨ |
| `BubbleMenu.tsx` | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è | –ö–Ω–æ–ø–∫–∏ —Ä–∞–∑–º–µ—Ç–∫–∏, —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã |
| `Toolbar.tsx` | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è | –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ |

---

## –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

1. **–°–æ–∑–¥–∞–Ω–∏–µ unmarked –±–ª–æ–∫–∞**
   - –û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ä–µ–∂–∏–º–µ "–°–∏–Ω—Ç–∞–∫—Å–∏—Å"
   - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ "–ß–∏—Å—Ç—ã–π"
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ—è–≤–∏–ª—Å—è unmarked –±–ª–æ–∫ –≤ –∫–æ–Ω—Ü–µ

2. **–†–∞–∑–º–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞**
   - –í —Ä–µ–∂–∏–º–µ "–°–∏–Ω—Ç–∞–∫—Å–∏—Å" –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ unmarked –±–ª–æ–∫–µ
   - –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ç–∏–ø–∞ –≤ BubbleMenu
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–æ–∑–¥–∞–ª—Å—è –Ω–æ–≤—ã–π –±–ª–æ–∫

3. **–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã**
   - –í—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ unmarked –±–ª–æ–∫–µ
   - –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å —Å—Ü–µ–Ω—É"
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è —Å—Ü–µ–Ω–∞ —Å —Ç–µ–∫—Å—Ç–æ–º

4. **–ü–µ—Ä–µ–Ω–æ—Å –±–ª–æ–∫–∞**
   - –ù–∞–∂–∞—Ç—å üé¨ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ unmarked –±–ª–æ–∫–∞
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤–µ—Å—å –±–ª–æ–∫ –ø–µ—Ä–µ–Ω—ë—Å—Å—è –≤ –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å

---

## –£–†–û–ö–ò

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ

1. **`node.content` vs `node.textContent`**
   - `textContent` —Å–∫–ª–µ–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
   - `content` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç Fragment —Å–æ –≤—Å–µ–º–∏ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞–º–∏

2. **–ü–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è**
   - –ü—Ä–∏ `tr.delete()` –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è
   - –ù—É–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å `adjustedPos = scenePos - (to - from)`

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º**
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å `lastBlockType !== 'unmarked'` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ

### –ü—Ä–æ—Ü–µ—Å—Å–Ω—ã–µ

1. **AI –Ω–µ –≤—Å–µ–≥–¥–∞ –ª—É—á—à–µ** ‚Äî —Ä—É—á–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥—ë–∂–Ω–µ–µ –¥–ª—è —Ç–æ—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
2. **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞** ‚Äî –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ –æ–¥–Ω–æ–π, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é
3. **–°–ª—É—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** ‚Äî –±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

---

## –°–í–Ø–ó–ê–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´

| –î–æ–∫—É–º–µ–Ω—Ç | –ü—É—Ç—å |
|----------|------|
| –†–µ—Ñ–ª–µ–∫—Å–∏—è | `memory-bank/reflection/reflection-MARKUP-001.md` |
| –ü—Ä–µ–¥—ã–¥—É—â–∞—è –∑–∞–¥–∞—á–∞ | `memory-bank/archive/archive-EDITOR-001.md` |

---

## –°–¢–ê–¢–£–°

‚úÖ **–ó–ê–î–ê–ß–ê –ó–ê–í–ï–†–®–ï–ù–ê –ò –ê–†–•–ò–í–ò–†–û–í–ê–ù–ê**

–î–∞—Ç–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏: 2026-01-18
