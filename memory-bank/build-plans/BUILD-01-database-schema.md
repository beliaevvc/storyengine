# BUILD-01: Database Schema Plan

> **Plan ID**: BUILD-01
> **Component**: Database Layer
> **Dependencies**: CP-1 (Database Schema Design)
> **Priority**: HIGH
> **Estimated Effort**: Phase 1 of Implementation
> **Status**: âœ… IMPLEMENTED (Prisma 7)

---

## âš ï¸ UPDATED VIA CONTEXT7

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ PLAN UPDATED: Prisma 5 â†’ Prisma 7                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Original plan used Prisma 5 patterns (deprecated)               â”‚
â”‚ Context7 query revealed breaking changes in Prisma 7:           â”‚
â”‚                                                                  â”‚
â”‚ â€¢ url in datasource block â†’ prisma.config.ts                   â”‚
â”‚ â€¢ PrismaClient() â†’ PrismaClient({ adapter })                   â”‚
â”‚ â€¢ @prisma/client â†’ ./generated/prisma/client                   â”‚
â”‚                                                                  â”‚
â”‚ Plan below UPDATED to reflect current Prisma 7 API.             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. OBJECTIVE

Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Prisma 7 ÑÑ…ĞµĞ¼Ñƒ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ñ€ĞµÑˆĞµĞ½Ğ¸ÑĞ¼ CP-1, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²ÑĞµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸, Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ, Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹ Ğ¸ seed Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.

---

## 2. FILES TO CREATE

### 2.1 Prisma Configuration

```
prisma/
â”œâ”€â”€ schema.prisma          # Main schema file
â”œâ”€â”€ migrations/            # Auto-generated by Prisma
â””â”€â”€ seed.ts               # Seed data for development
```

### 2.2 Infrastructure Layer

```
src/infrastructure/database/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ client.ts         # Prisma client singleton
â”‚   â””â”€â”€ index.ts          # Export
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ PrismaProjectRepository.ts
â”‚   â”œâ”€â”€ PrismaEntityRepository.ts
â”‚   â”œâ”€â”€ PrismaDocumentRepository.ts
â”‚   â”œâ”€â”€ PrismaSceneRepository.ts
â”‚   â””â”€â”€ index.ts
â””â”€â”€ mappers/
    â”œâ”€â”€ projectMapper.ts
    â”œâ”€â”€ entityMapper.ts
    â”œâ”€â”€ documentMapper.ts
    â”œâ”€â”€ sceneMapper.ts
    â””â”€â”€ index.ts
```

---

## 3. IMPLEMENTATION STEPS

### Step 1: Create Prisma Schema (Prisma 7)

**File**: `prisma/schema.prisma`

```prisma
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma/client"
}

datasource db {
  provider = "postgresql"
  // URL configured in prisma.config.ts (Prisma 7+)
}

// ============================================
// ENUMS
// ============================================

enum EntityType {
  CHARACTER
  LOCATION
  ITEM
  EVENT
  CONCEPT
}

// ============================================
// MODELS
// ============================================

model Project {
  id          String   @id @default(uuid())
  title       String
  description String?
  settings    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  documents   Document[]
  entities    Entity[]

  @@index([title])
}

model Entity {
  id          String     @id @default(uuid())
  projectId   String
  type        EntityType
  name        String
  description String?
  attributes  Json       @default("{}")
  imageUrl    String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scenes      SceneEntity[]

  @@index([projectId, type])
  @@index([name])
}

model Document {
  id        String   @id @default(uuid())
  projectId String
  title     String
  content   Json     @default("{}")
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scenes    Scene[]

  @@index([projectId, order])
}

model Scene {
  id          String   @id @default(uuid())
  documentId  String
  title       String?
  summary     String?
  startOffset Int?
  endOffset   Int?
  metadata    Json     @default("{}")
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  document    Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  entities    SceneEntity[]

  @@index([documentId, order])
}

model SceneEntity {
  id        String   @id @default(uuid())
  sceneId   String
  entityId  String
  role      String?
  notes     String?
  createdAt DateTime @default(now())

  scene     Scene    @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  entity    Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([sceneId, entityId])
  @@index([sceneId])
  @@index([entityId])
}
```

### Step 1.5: Create Prisma Config (Prisma 7 - NEW!)

**File**: `prisma.config.ts`

```typescript
import 'dotenv/config';
import { defineConfig } from 'prisma/config';

export default defineConfig({
  schema: 'prisma/schema.prisma',
  migrations: {
    path: 'prisma/migrations',
  },
  datasource: {
    url: process.env.DATABASE_URL!,
  },
});
```

### Step 2: Create Prisma Client Singleton (Prisma 7 - Adapter Pattern)

**File**: `src/infrastructure/database/prisma/client.ts`

```typescript
import 'dotenv/config';
import { PrismaClient } from '@/generated/prisma/client';
import { PrismaPg } from '@prisma/adapter-pg';

// Prisma 7+ uses adapter pattern for database connections
const connectionString = process.env.DATABASE_URL!;
const adapter = new PrismaPg({ connectionString });

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    adapter,
    log: process.env.NODE_ENV === 'development' 
      ? ['query', 'error', 'warn'] 
      : ['error'],
  });

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma;
}

export default prisma;
```

### Step 3: Create Seed Data (Prisma 7)

**File**: `prisma/seed.ts`

```typescript
import 'dotenv/config';
import { PrismaClient, EntityType } from '../src/generated/prisma/client';
import { PrismaPg } from '@prisma/adapter-pg';

// Prisma 7+ requires adapter
const adapter = new PrismaPg({ connectionString: process.env.DATABASE_URL! });
const prisma = new PrismaClient({ adapter });

async function main() {
  // Create sample project
  const project = await prisma.project.create({
    data: {
      title: 'Sample Mystery Novel',
      description: 'A detective story set in Victorian London',
      settings: {
        genre: 'mystery',
        setting: 'Victorian London',
        targetWordCount: 80000,
      },
    },
  });

  // Create entities
  const detective = await prisma.entity.create({
    data: {
      projectId: project.id,
      type: EntityType.CHARACTER,
      name: 'John Watson',
      description: 'A brilliant detective with a keen eye for detail',
      attributes: {
        age: 45,
        occupation: 'Private Detective',
        traits: ['observant', 'logical', 'persistent'],
        status: 'alive',
      },
    },
  });

  const london = await prisma.entity.create({
    data: {
      projectId: project.id,
      type: EntityType.LOCATION,
      name: 'Baker Street Office',
      description: 'The detective\'s office and residence',
      attributes: {
        locationType: 'building',
        address: '221B Baker Street, London',
        atmosphere: 'cluttered but cozy',
      },
    },
  });

  const pocket_watch = await prisma.entity.create({
    data: {
      projectId: project.id,
      type: EntityType.ITEM,
      name: 'Golden Pocket Watch',
      description: 'A mysterious pocket watch found at the crime scene',
      attributes: {
        itemType: 'evidence',
        rarity: 'rare',
        properties: ['engraved initials J.M.', 'stopped at 3:15'],
      },
    },
  });

  // Create document
  const chapter1 = await prisma.document.create({
    data: {
      projectId: project.id,
      title: 'Chapter 1: The Mysterious Client',
      order: 1,
      content: {
        type: 'doc',
        content: [
          {
            type: 'heading',
            attrs: { level: 1 },
            content: [{ type: 'text', text: 'Chapter 1: The Mysterious Client' }],
          },
          {
            type: 'paragraph',
            content: [
              { type: 'text', text: 'John Watson sat in his ' },
              { type: 'text', text: 'Baker Street Office', marks: [{ type: 'entityMark', attrs: { entityId: london.id, entityType: 'LOCATION', entityName: 'Baker Street Office' } }] },
              { type: 'text', text: ', examining the ' },
              { type: 'text', text: 'Golden Pocket Watch', marks: [{ type: 'entityMark', attrs: { entityId: pocket_watch.id, entityType: 'ITEM', entityName: 'Golden Pocket Watch' } }] },
              { type: 'text', text: ' that had been left on his doorstep that morning.' },
            ],
          },
        ],
      },
    },
  });

  // Create scene
  const scene1 = await prisma.scene.create({
    data: {
      documentId: chapter1.id,
      title: 'The Discovery',
      summary: 'Watson discovers the mysterious pocket watch',
      order: 1,
      metadata: {
        mood: 'mysterious',
        timeOfDay: 'morning',
      },
    },
  });

  // Link entities to scene
  await prisma.sceneEntity.createMany({
    data: [
      { sceneId: scene1.id, entityId: detective.id, role: 'protagonist' },
      { sceneId: scene1.id, entityId: london.id, role: 'setting' },
      { sceneId: scene1.id, entityId: pocket_watch.id, role: 'macguffin' },
    ],
  });

  console.log('Seed data created successfully!');
  console.log({ project, detective, london, pocket_watch, chapter1, scene1 });
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

### Step 4: Update package.json

Add to `package.json`:

```json
{
  "prisma": {
    "seed": "ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"
  }
}
```

---

## 4. COMMANDS TO EXECUTE (Prisma 7)

```bash
# 1. Install Prisma 7 dependencies (ALWAYS use @latest!)
npm install prisma@latest @prisma/client@latest @prisma/adapter-pg@latest dotenv
npm install -D ts-node

# 2. Generate Prisma Client
npx prisma generate

# 3. Create migration (requires running PostgreSQL)
npx prisma migrate dev --name init

# 4. Run seed
npx prisma db seed

# 5. Open Prisma Studio (for verification)
npx prisma studio
```

**Note**: Prisma 7 uses `prisma.config.ts` for CLI configuration.

---

## 5. ENVIRONMENT SETUP

**File**: `.env`

```env
DATABASE_URL="postgresql://postgres:password@localhost:5432/storyengine?schema=public"
```

**File**: `.env.example`

```env
DATABASE_URL="postgresql://user:password@localhost:5432/storyengine?schema=public"
```

---

## 6. SUCCESS CRITERIA

| # | Criterion | Validation |
|---|-----------|------------|
| 1 | Prisma schema valid | `npx prisma validate` passes |
| 2 | Migration successful | `npx prisma migrate dev` completes |
| 3 | Client generated | `@prisma/client` importable |
| 4 | Seed runs | Sample data in database |
| 5 | All relations work | Query with includes succeeds |
| 6 | Cascade delete works | Deleting Project removes all related data |

---

## 7. TESTING QUERIES

```typescript
// Test queries to verify schema

// 1. Create project with all relations
const project = await prisma.project.create({
  data: {
    title: 'Test Project',
    entities: {
      create: {
        type: 'CHARACTER',
        name: 'Test Character',
      },
    },
    documents: {
      create: {
        title: 'Test Document',
        scenes: {
          create: {
            title: 'Test Scene',
          },
        },
      },
    },
  },
  include: {
    entities: true,
    documents: {
      include: {
        scenes: true,
      },
    },
  },
});

// 2. Query entities by type
const characters = await prisma.entity.findMany({
  where: {
    projectId: project.id,
    type: 'CHARACTER',
  },
});

// 3. Query scenes with entities
const scenesWithEntities = await prisma.scene.findMany({
  where: {
    document: {
      projectId: project.id,
    },
  },
  include: {
    entities: {
      include: {
        entity: true,
      },
    },
  },
});

// 4. Cascade delete test
await prisma.project.delete({
  where: { id: project.id },
});
// All related entities, documents, scenes, sceneEntities should be deleted
```

---

## 8. NOTES

- PostgreSQL 14+ required for JSONB support
- Use Docker for local PostgreSQL: `docker run --name storyengine-db -e POSTGRES_PASSWORD=password -p 5432:5432 -d postgres:14`
- Prisma Studio available at http://localhost:5555 after `npx prisma studio`

---

## 9. CONTEXT7 VERIFICATION LOG

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context7 Query: 2026-01-17                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Library ID: /prisma/docs                                        â”‚
â”‚ Query: "Prisma 7 prisma.config.ts migration breaking changes"   â”‚
â”‚                                                                  â”‚
â”‚ Key Findings:                                                    â”‚
â”‚ â€¢ url in datasource block is DEPRECATED                         â”‚
â”‚ â€¢ Must use prisma.config.ts for CLI                            â”‚
â”‚ â€¢ PrismaClient requires adapter (@prisma/adapter-pg)           â”‚
â”‚ â€¢ Generated client path changed                                  â”‚
â”‚                                                                  â”‚
â”‚ Action: Plan UPDATED to use Prisma 7 patterns                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
